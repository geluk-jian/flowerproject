<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ê½ƒì„ ë§Œì§€ëŠ” ëˆ„ë‚˜ê°€ ë„ì™€ë“œë¦¼</title>
  <style>
    :root{
      /* ë°ì€ ì›í†¤ */
      --bg:#f4f5f7;

      /* ì¹´ë“œ/í…ìŠ¤íŠ¸ */
      --card:#ffffff;
      --text:#0f172a;
      --muted:#64748b;

      /* ë¼ì¸/ê·¸ë¦¼ì */
      --line:#e5e7eb;
      --ink:#111827;
      --shadow: 0 10px 30px rgba(15, 23, 42, .08);

      /* í¬ì¸íŠ¸(ê·¸ë¦°) */
      --accent:#22c55e; /* green */
      --accentDark:#16a34a;

      --radius: 18px;
      --pad: 18px;
      --max: 760px;
    }

    *{box-sizing:border-box}

    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Apple SD Gothic Neo","Noto Sans KR","Malgun Gothic", sans-serif;
      background: var(--bg);          /* âœ… ê·¸ë¼ë°ì´ì…˜ ì œê±° */
      color:var(--text);
      line-height:1.45;
    }

    .wrap{max-width:var(--max); margin:0 auto; padding:24px 16px 60px;}

    .card{
      border:1px solid var(--line);
      border-radius:var(--radius);
      background: var(--card);
      box-shadow: var(--shadow);
      overflow:hidden;
    }

    .hd{
      padding:14px var(--pad);
      border-bottom:1px solid var(--line);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      background: #fff;
    }

    .hd h1, .hd h2{margin:0; font-size:16px; letter-spacing:-.2px; color: var(--text);}

    .bd{padding: var(--pad);}

    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px; border:1px solid var(--line); border-radius:999px;
      color:var(--muted); font-size:12px;
      background: #fff;
      user-select:none;
      white-space:nowrap;
    }

    .muted{color:var(--muted)}

    .hero{
      padding:22px 18px;
      border:1px solid var(--line);
      border-radius: var(--radius);
      background: #fff;
    }

    .hero h1{
      font-size:22px;
      margin:0 0 8px;
      letter-spacing:-.4px;
      font-weight:900;
      color:var(--text);
    }

    .hero p{margin:0 0 10px; color:var(--muted); font-size:14px;}

    .hero .mini{
      margin-top:10px;
      font-size:13px;
      color: var(--text);
      opacity:.9;
    }

    .btnrow{display:flex; gap:10px; flex-wrap:wrap; margin-top:14px;}

    button{
      appearance:none;
      border:1px solid var(--accent);
      background: var(--accent);
      color: #fff;
      padding: 12px 14px;
      border-radius: 14px;
      cursor:pointer;
      font-weight:800;
      letter-spacing:-.1px;
      transition: transform .08s ease, background .15s ease, border-color .15s ease;
    }
    button:hover{transform: translateY(-1px); background: var(--accentDark); border-color: var(--accentDark);}

    button.secondary{
      border:1px solid var(--line);
      background: #fff;
      color: var(--text);
      font-weight:800;
    }
    button.secondary:hover{background:#f8fafc; border-color:#d1d5db;}

    .screen{display:none;}
    .screen.active{display:block;}

    .progressWrap{
      margin: 0 0 14px;
      padding: 10px 12px;
      border:1px solid var(--line);
      border-radius: 14px;
      background: #fff;
    }

    .progressTop{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      font-size:12px; color:var(--muted);
      margin-bottom:8px;
      font-weight:700;
    }

    .bar{
      height:10px;
      border-radius:999px;
      background: #eef2f7;
      overflow:hidden;
      border:1px solid #e5e7eb;
    }

    .bar > div{
      height:100%;
      width:0%;
      background: var(--accent); /* âœ… ê·¸ë¦° */
      transition: width .25s ease;
    }

    /* âœ… Q í°íŠ¸(ì‚¬ì§„ ëŠë‚Œ: êµµê³  í¬ê²Œ, ê°€ìš´ë°) */
    .q{
      margin: 6px 0 10px;
      font-size: 24px;
      line-height: 1.25;
      letter-spacing: -0.6px;
      font-weight: 900;
      text-align:center;
      color: var(--text);
    }

    .sub{
      margin:0 0 16px;
      color:var(--muted);
      font-size:13px;
      text-align:center;
      font-weight:650;
    }

    .options{
      display:grid;
      grid-template-columns: 1fr;
      gap:12px;
    }

    /* âœ… ABëŠ” í•­ìƒ 2ì¹¸(í°ì—ì„œë„) */
    .options.two{
      grid-template-columns: 1fr 1fr;
    }

    @media (max-width: 360px){
      .options.two{ grid-template-columns: 1fr; } /* ë„ˆë¬´ ì¢ìœ¼ë©´ 1ì¹¸ */
    }

    /* âœ… ì„ íƒ ë°•ìŠ¤: ê¸°ë³¸ í°ìƒ‰, ë‘êº¼ìš´ í…Œë‘ë¦¬, ê·¸ë¦¼ì */
    .opt{
      border:2px solid var(--ink);
      background: #fff;
      padding:16px 14px;
      border-radius: 18px;
      cursor:pointer;
      transition: transform .08s ease, border-color .15s ease, background .15s ease, color .15s ease;
      display:flex;
      align-items:flex-start;
      gap:10px;

      /* ì‚¬ì§„ì²˜ëŸ¼ ì‚´ì§ ëœ¬ ëŠë‚Œ */
      box-shadow: 0 8px 0 rgba(17,24,39,.10);
    }

    .opt:hover{transform: translateY(-1px); border-color: var(--accent);}

    /* âœ… ì„ íƒ í›„ ê·¸ë¦° */
    .opt[data-selected="true"]{
      border-color: var(--accent);
      background: var(--accent);
      color:#fff;
    }

    .opt .title{
      font-weight: 900;
      letter-spacing:-.2px;
      color: inherit;
      font-size: 15px;
    }

    .opt .desc{
      font-size:12px;
      color: var(--muted);
      margin-top:6px;
      font-weight:650;
    }

    .opt[data-selected="true"] .desc{
      color: rgba(255,255,255,.92);
    }

    /* âœ… AB ë°•ìŠ¤ ìŠ¤íƒ€ì¼ (A./B. ë¼ë²¨ í¬ê²Œ) */
    .opt.abOpt{
      flex-direction: column;
      justify-content: center;
      align-items: center;
      text-align:center;
      padding:18px 14px;
      min-height: 120px;
      gap:8px;
    }

    .abBadge{
      font-weight: 1000;
      font-size: 22px;
      line-height: 1;
      letter-spacing:-.2px;
      color: inherit;
    }

    .abTitle{
      font-weight: 950;
      font-size: 16px;
      letter-spacing:-.3px;
      color: inherit;
    }

    .abDesc{
      font-size:12px;
      font-weight:700;
      color: var(--muted);
    }
    .opt[data-selected="true"] .abDesc{
      color: rgba(255,255,255,.92);
    }

    .footnote{margin-top:12px; font-size:12px; color:var(--muted); font-weight:600;}
    .trustline{
      margin-top:8px;
      font-size:12px;
      color:var(--text);
      font-weight:800;
    }

    .box{
      border:1px solid var(--line);
      background: #fff;
      border-radius: 16px;
      padding: 14px;
      margin-top: 12px;
    }

    .box h3{margin:0 0 8px; font-size:14px; font-weight:900; letter-spacing:-.2px;}
    .top3{display:grid; gap:10px;}
    .topItem{
      border:1px solid var(--line);
      border-radius:14px;
      background:#fff;
      padding:12px;
      font-weight:900;
      font-size:15px;
      letter-spacing:-.2px;
    }
    .topItem small{
      display:block;
      margin-top:4px;
      font-size:12px;
      color:var(--muted);
      font-weight:700;
    }
    details.explain{
      border:1px solid var(--line);
      border-radius:12px;
      padding:10px 12px;
      background:#fff;
    }
    details.explain summary{
      cursor:pointer;
      font-weight:900;
      font-size:13px;
      color:var(--text);
      list-style:none;
    }
    details.explain summary::-webkit-details-marker{display:none;}
    details.explain p{
      margin:8px 0 0;
      font-size:13px;
      color:var(--muted);
      font-weight:700;
    }

    .chips{display:flex; flex-wrap:wrap; gap:8px;}
    .chip{
      font-size:12px; color: var(--text);
      padding:6px 10px; border-radius:999px;
      border:1px solid var(--line);
      background: #f8fafc;
      font-weight:800;
    }

    .samplePhoto{
      margin: 0 0 10px;
      border:1px solid var(--line);
      border-radius: 14px;
      overflow: hidden;
      background: #f8fafc;
    }
    .samplePhoto img{
      display:block;
      width:100%;
      height:220px;
      object-fit:cover;
    }
    .samplePhoto .cap{
      padding:8px 10px;
      font-size:12px;
      color:var(--muted);
      font-weight:700;
      border-top:1px solid var(--line);
      background:#fff;
    }

    .palette{
      margin-top:10px;
      display:grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap:8px;
    }
    .swatch{
      border:1px solid var(--line);
      border-radius:12px;
      overflow:hidden;
      background:#fff;
    }
    .swatchColor{
      height:34px;
      border-bottom:1px solid var(--line);
    }
    .swatchMeta{
      padding:6px 8px;
      font-size:11px;
      color:var(--text);
      font-weight:800;
      text-align:center;
      letter-spacing:-.1px;
    }

    .list{margin:8px 0 0; padding-left: 18px; font-size:13px; color: var(--text); font-weight:650;}
    .list li{margin:4px 0;}

    .toast{
      position: fixed; left: 50%; bottom: 18px; transform: translateX(-50%);
      background: rgba(17,24,39,.92);
      border: 1px solid rgba(255,255,255,.18);
      color: #fff;
      padding: 10px 12px;
      border-radius: 14px;
      box-shadow: var(--shadow);
      font-size: 13px;
      opacity: 0; pointer-events:none;
      transition: opacity .15s ease;
      z-index: 9999;
      font-weight:700;
    }
    .toast.show{opacity:1;}

    .divider{height:1px; background: #eef2f7; margin:12px 0;}

    .ctaPro{
      border: 1px dashed rgba(34,197,94,.55);
      background: rgba(34,197,94,.06);
    }
  </style>
</head>
<body>
  <div class="wrap">

    <section class="screen active" id="screenStart">
      <div class="card">
        <div class="hd">
          <h2>ğŸŒ· ê½ƒì„ ë§Œì§€ëŠ” ëˆ„ë‚˜ê°€ ë„ì™€ë“œë¦¼</h2>
          <span class="pill">ë¬´ë£Œ í…ŒìŠ¤íŠ¸</span>
        </div>
        <div class="bd">
          <div class="hero">
            <h1>ê·¸ë…€ì˜ ì·¨í–¥, ê½ƒ ê³¨ë¼ë“œë ¤ìš”</h1>
            <p>10ë…„ì°¨ ê½ƒì§‘ ì‚¬ì¥ ëˆ„ë‚˜ê°€ <b>ì–´ìš¸ë¦¬ëŠ” ê½ƒ ì»¨ì…‰ + ê½ƒ ì˜ë¯¸ + ë©˜íŠ¸</b>ê¹Œì§€ ì‹¸ì•… í•œ ë²ˆì— ì •ë¦¬í•´ì¤„ê²Œ.</p>
            <div class="trustline">10ë…„ê°„ ë‚¨ì ì†ë‹˜ â€˜ì˜ˆì˜ê²Œìš”â€¦â€™ 1ë§Œ ë²ˆ ë“£ê³  ë§Œë“  ì„œë¹„ìŠ¤</div>
            <div class="mini">âœ… 30ì´ˆ ì„ íƒ Â· âœ… ê²°ê³¼ ë§í¬ ê³µìœ  Â· âœ… ë©˜íŠ¸ ë³µì‚¬</div>
            <div class="btnrow">
              <button id="btnStart">ì‹œì‘í•˜ê¸°</button>
              <button class="secondary" id="btnLoadExample" type="button">ì˜ˆì‹œ ê²°ê³¼ ë³´ê¸°</button>
            </div>
            <div class="footnote">â€» ê½ƒë§ì€ í•´ì„ì´ ì—¬ëŸ¬ ê°€ì§€ì¼ ìˆ˜ ìˆì–´ìš”.</div>
          </div>
        </div>
      </div>
    </section>

    <section class="screen" id="screenQuiz">
      <div class="card">
        <div class="hd">
          <h2 id="quizTitle">ì„ íƒ</h2>
          <span class="pill" id="quizPill">ì¹œí•œ ëˆ„ë‚˜ ëª¨ë“œ</span>
        </div>
        <div class="bd">
          <div class="progressWrap">
            <div class="progressTop">
              <span id="stepText">1/7</span>
              <span id="stepHint">ì„ íƒí•˜ë©´ ë‹¤ìŒìœ¼ë¡œ ë„˜ì–´ê°€ìš”</span>
            </div>
            <div class="bar"><div id="barFill"></div></div>
          </div>

          <h2 class="q" id="qText">Q. ì§ˆë¬¸</h2>
          <p class="sub" id="qSub">ì„¤ëª…</p>

          <div class="options" id="options"></div>

          <div class="btnrow">
            <button class="secondary" id="btnBack" type="button">ì´ì „</button>
            <button id="btnNext" type="button" style="display:none;">ë‹¤ìŒ</button>
            <button class="secondary" id="btnRestart" type="button">ì²˜ìŒìœ¼ë¡œ</button>
          </div>

          <div class="footnote" id="quizFootnote"></div>
        </div>
      </div>
    </section>

    <section class="screen" id="screenResult">
      <div class="card">
        <div class="hd">
          <h2>ë¬´ë£Œ ê²°ê³¼</h2>
          <span class="pill">ê½ƒ+ë©˜íŠ¸ ì™„ì„±</span>
        </div>
        <div class="bd" id="resultArea"></div>
      </div>
    </section>

  </div>

  <div id="toast" class="toast">ë³µì‚¬í–ˆì–´!</div>

  <script>
    const $ = (id) => document.getElementById(id);

    function escapeHtml(value) {
      return String(value)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }

    function toast(msg){
      const el = $('toast');
      el.textContent = msg;
      el.classList.add('show');
      setTimeout(()=> el.classList.remove('show'), 1200);
    }

    async function copyText(text){
      try{
        if(navigator.clipboard && window.isSecureContext){
          await navigator.clipboard.writeText(text);
          return true;
        }
      }catch(e){}
      try{
        const ta = document.createElement('textarea');
        ta.value = text;
        ta.style.position = 'fixed';
        ta.style.left = '-9999px';
        ta.style.top = '0';
        document.body.appendChild(ta);
        ta.focus();
        ta.select();
        const ok = document.execCommand('copy');
        document.body.removeChild(ta);
        return ok;
      }catch(e){
        return false;
      }
    }

    function base64UrlEncode(obj){
      const json = JSON.stringify(obj);
      const bytes = new TextEncoder().encode(json);
      let bin = '';
      for (const b of bytes) bin += String.fromCharCode(b);
      const b64 = btoa(bin).replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'');
      return b64;
    }

    function base64UrlDecode(str){
      const b64 = str.replace(/-/g,'+').replace(/_/g,'/');
      const pad = b64 + '==='.slice((b64.length + 3) % 4);
      const bin = atob(pad);
      const bytes = Uint8Array.from(bin, c => c.charCodeAt(0));
      const json = new TextDecoder().decode(bytes);
      return JSON.parse(json);
    }

    function showScreen(which){
      ['screenStart','screenQuiz','screenResult'].forEach(id=>{
        $(id).classList.toggle('active', id === which);
      });
      window.scrollTo({top:0, behavior:'smooth'});
    }

    const steps = [
      {
        id:'relation',
        type:'single',
        title:'ëˆ„êµ¬í•œí…Œ ì£¼ëŠ” ê±°ì•¼?',
        sub:'ê´€ê³„ë§Œ ê³ ë¥´ë©´ ë©˜íŠ¸ í†¤ì´ ë°”ë¡œ ë§ì¶°ì ¸ìš”.',
        options:[
          {value:'ì¸/ì†Œê°œíŒ…', title:'ì¸/ì†Œê°œíŒ…', desc:'ê°€ë³ê²Œ ì„¼ìŠ¤ë§Œ'},
          {value:'ì—¬ìì¹œêµ¬(ì—°ì¸)', title:'ì—¬ìì¹œêµ¬(ì—°ì¸)', desc:'ì„¤ë ˜ + ë‹¤ì •'},
          {value:'ì•„ë‚´/ë°°ìš°ì', title:'ì•„ë‚´/ë°°ìš°ì', desc:'ê³ ë§ˆì›€ + ì¡´ì¤‘'},
          {value:'ì¹œêµ¬/ë™ë£Œ', title:'ì¹œêµ¬/ë™ë£Œ', desc:'ë‹´ë°± + ì‘ì›'}
        ]
      },
      {
        id:'occasion',
        type:'single',
        title:'ì˜¤ëŠ˜ì€ ì–´ë–¤ ë‚ ì´ì•¼?',
        sub:'ì˜¤ëŠ˜ ìƒí™©ì— ë§ëŠ” ì´ìœ ì™€ ë¬´ë“œë¥¼ ì •í•´ìš”.',
        options:[
          {value:'ìƒì¼', title:'ìƒì¼', desc:'ì¶•í•˜ ë¬´ë“œ'},
          {value:'ê¸°ë…ì¼', title:'ê¸°ë…ì¼', desc:'ê´€ê³„ì˜ í™•ì‹ '},
          {value:'ì‚¬ê³¼(ë¯¸ì•ˆí•´)', title:'ì‚¬ê³¼(ë¯¸ì•ˆí•´)', desc:'ë¶€ë‹´ ë§ê³  ì§„ì‹¬'},
          {value:'ì¶•í•˜(í•©ê²©/ìŠ¹ì§„/ìƒˆì¶œë°œ)', title:'ì¶•í•˜(í•©ê²©/ìŠ¹ì§„/ìƒˆì¶œë°œ)', desc:'ì‘ì›/ìë¶€ì‹¬'},
          {value:'ì²« ì„ ë¬¼', title:'ì²« ì„ ë¬¼', desc:'ì•ˆì „í•˜ê²Œ í˜¸ê°'},
          {value:'ê·¸ëƒ¥(ê³ ë§™ê³  ì‘ì›)', title:'ê·¸ëƒ¥(ê³ ë§™ê³  ì‘ì›)', desc:'ì¼ìƒ ì† ì •ì„±'}
        ]
      },
      {
        id:'brightness',
        type:'ab',
        title:'ë¶„ìœ„ê¸° ë¨¼ì € ê³¨ë¼. ë‘˜ ì¤‘ í•˜ë‚˜!',
        sub:'ë°ê²Œ ê°ˆì§€, ì°¨ë¶„í•˜ê²Œ ê°ˆì§€ ë¨¼ì € ì •í•´ìš”.',
        options:[
          {value:'bright', title:'í™”ì‚¬í•˜ê²Œ', desc:'ë°ê³  ê¸°ë¶„ ì¢‹ì•„ì§€ëŠ” ëŠë‚Œ'},
          {value:'calm', title:'ì°¨ë¶„í•˜ê²Œ', desc:'í†¤ë‹¤ìš´, í¸ì•ˆí•˜ê³  ê³ ê¸‰ìŠ¤ëŸ½ê²Œ'}
        ]
      },
      {
        id:'style',
        type:'ab',
        title:'ëŠë‚Œì€ ì–´ë–¤ ìª½ì´ ë” ê·¸ ì‚¬ëŒ ê°™ì•„?',
        sub:'ê°€ë³ê²Œ ì§ê°ëŒ€ë¡œ ê³ ë¥´ë©´ ì¶©ë¶„í•´ìš”.',
        options:[
          {value:'cute', title:'ê·€ì—½ê²Œ', desc:'ë°œë„/ëŸ¬ë¸”ë¦¬ ê³„ì—´'},
          {value:'chic', title:'ì„¸ë ¨ë˜ê²Œ', desc:'ê¹”ë”/ë„ì‹œì  ê³„ì—´'}
        ]
      },
      {
        id:'volume',
        type:'ab',
        title:'ë³¼ë¥¨ì€?',
        sub:'ì‹¬í”Œ/í’ì„± ì„ íƒìœ¼ë¡œ ì¸ìƒì´ í™• ë‹¬ë¼ì ¸ìš”.',
        options:[
          {value:'simple', title:'ì‹¬í”Œí•˜ê²Œ', desc:'ì •ëˆëœ ëŠë‚Œ'},
          {value:'lush', title:'í’ì„±í•˜ê²Œ', desc:'ì¡´ì¬ê° ìˆëŠ” ëŠë‚Œ'}
        ]
      },
      {
        id:'taboos',
        type:'multi',
        title:'í”¼í•´ì•¼ í•  ê±° ìˆì–´?',
        sub:'ì—†ìœ¼ë©´ â€œì—†ìŒâ€ë§Œ ëˆ„ë¥´ê³  ë„˜ì–´ê°€ë©´ ë¼ìš”.',
        footnote:'â€» â€œì—†ìŒâ€ì„ ê³ ë¥´ë©´ ë‹¤ë¥¸ ê¸ˆê¸°ëŠ” ìë™ í•´ì œë¼ìš”.',
        options:[
          {value:'í–¥ ê°•í•œ ê½ƒì€ ì‹«ì–´í•¨', title:'í–¥ ê°•í•œ ê½ƒì€ ì‹«ì–´í•´ìš”', desc:'í–¥ ë¯¼ê°'},
          {value:'ì¥ë¯¸ëŠ” ì‹«ì–´í•¨', title:'ì¥ë¯¸ëŠ” ì‹«ì–´í•´ìš”', desc:'ì·¨í–¥/ê¸°ì–µ'},
          {value:'í™”ë ¤í•œ ê±´ ë¶€ë‹´', title:'í™”ë ¤í•œ ê±´ ë¶€ë‹´ìŠ¤ëŸ¬ì›Œìš”', desc:'í†¤ì„ ì¤„ì´ë©´ ì•ˆì „'},
          {value:'ì•Œë ˆë¥´ê¸°/ë¯¼ê° ìˆìŒ', title:'ì•Œë ˆë¥´ê¸°/ë¯¼ê° ìˆì–´ìš”', desc:'ê½ƒê°€ë£¨/í–¥ ìµœì†Œ'},
          {value:'ì—†ìŒ', title:'ì—†ìŒ', desc:'íŠ¹ë³„í•œ ê¸ˆê¸° ì—†ìŒ'}
        ]
      },
      {
        id:'urgency',
        type:'single',
        title:'ì–¸ì œ í•„ìš”í•´?',
        sub:'ë‚©ê¸° ê¸°ì¤€ìœ¼ë¡œ ê°€ëŠ¥í•œ ì¡°í•©ì„ ê³ ë¥¼ê²Œìš”.',
        options:[
          {value:'ì˜¤ëŠ˜(ë‹¹ì¼)', title:'ì˜¤ëŠ˜(ë‹¹ì¼)', desc:'ë¹ ë¥´ê²Œ ì œì‘ ê°€ëŠ¥í•œ ì¡°í•©'},
          {value:'ë‚´ì¼', title:'ë‚´ì¼', desc:'ì›í•˜ëŠ” í†¤ì€ ê°€ëŠ¥, í’ˆì ˆ ëŒ€ì²´ëŠ” í•„ìš”'},
          {value:'ì—¬ìœ (2â€“7ì¼)', title:'ì—¬ìœ (2â€“7ì¼)', desc:'ì›í•˜ëŠ” ê½ƒ ë°˜ì˜ ê°€ëŠ¥'}
        ]
      }
    ];

    const allowedValues = steps.reduce((acc, step) => {
      acc[step.id] = new Set(step.options.map(o => o.value));
      return acc;
    }, {});

    function sanitizeLoadedState(raw){
      const normalized = {
        relation: null,
        occasion: null,
        brightness: null,
        style: null,
        volume: null,
        taboos: [],
        urgency: null
      };

      if (!raw || typeof raw !== 'object') return normalized;

      ['relation', 'occasion', 'brightness', 'style', 'volume', 'urgency'].forEach((key)=>{
        const value = raw[key];
        normalized[key] = allowedValues[key].has(value) ? value : null;
      });

      if (Array.isArray(raw.taboos)) {
        const cleaned = raw.taboos.filter(v => allowedValues.taboos.has(v));
        normalized.taboos = Array.from(new Set(cleaned));
      }

      if (normalized.taboos.includes('ì—†ìŒ')) {
        normalized.taboos = ['ì—†ìŒ'];
      }

      return normalized;
    }

    const sisterLines = [
      'ìì•„! "ì•Œì•„ì„œ ê·¸ëƒ¥, ë§ì´ íŒ”ë¦¬ëŠ” ê½ƒ ì£¼ì„¸ìš”.ëŠ” ê·¸ë§Œ!"',
      'ë””í…Œì¼ ìš•ì‹¬ ê¸ˆì§€. ë¬´ë“œë§Œ ë§ì¶”ë©´ ë°˜ì€ ë¨¹ê³  ë“¤ì–´ê°€.',
      'ê¸ˆê¸° ì²´í¬ë§Œ ì œëŒ€ë¡œ í•˜ë©´, ì‹¤íŒ¨ í™•ë¥  í™• ì¤„ì–´.'
    ];

    const paletteByPersonality = {
      'ëŸ¬ë¸”ë¦¬': [
        { name:'Rose Quartz', hex:'#F7CAC9' },
        { name:'Peach Echo', hex:'#F7B39B' },
        { name:'Cream Tan', hex:'#F3E0BE' }
      ],
      'ì„¸ë ¨ë¨': [
        { name:'Cloud Dancer', hex:'#F0EEE9' },
        { name:'Harbor Mist', hex:'#BFC9C2' },
        { name:'Urban Chic', hex:'#464646' }
      ],
      'ê·€ì—¬ì›€': [
        { name:'Lemon Zest', hex:'#F9E547' },
        { name:'Bubblegum', hex:'#FF77A9' },
        { name:'Apricot', hex:'#FFB482' }
      ],
      'ë¯¸ë‹ˆë©€': [
        { name:'Snow White', hex:'#F8F7F2' },
        { name:'Silk Gray', hex:'#D9D9D6' },
        { name:'Sage Hint', hex:'#C9D4C5' }
      ],
      'ìš°ì•„í•¨': [
        { name:'Muted Blush', hex:'#D9A5A0' },
        { name:'Champagne', hex:'#F3E5C8' },
        { name:'Vintage Green', hex:'#708D81' }
      ],
      'í™œê¸°': [
        { name:'Sunflower', hex:'#FFD23F' },
        { name:'Orange Pop', hex:'#FF8C42' },
        { name:'Fresh Leaf', hex:'#7DBA3A' }
      ]
    };

    const bouquetPhotoByPersonality = {
      'ëŸ¬ë¸”ë¦¬': 'https://images.unsplash.com/photo-1487070183336-b863922373d4?auto=format&fit=crop&w=1200&q=80',
      'ì„¸ë ¨ë¨': 'https://images.unsplash.com/photo-1526394931762-8a4116f7ff89?auto=format&fit=crop&w=1200&q=80',
      'ê·€ì—¬ì›€': 'https://images.unsplash.com/photo-1527061011665-3652c757a4d4?auto=format&fit=crop&w=1200&q=80',
      'ë¯¸ë‹ˆë©€': 'https://images.unsplash.com/photo-1468327768560-75b778cbb551?auto=format&fit=crop&w=1200&q=80',
      'ìš°ì•„í•¨': 'https://images.unsplash.com/photo-1525310072745-f49212b5ac6d?auto=format&fit=crop&w=1200&q=80',
      'í™œê¸°': 'https://images.unsplash.com/photo-1494972308805-463bc619d34e?auto=format&fit=crop&w=1200&q=80'
    };

    const flowerPhotoByName = {
      'íŠ¤ë¦½': 'https://images.unsplash.com/photo-1524594227088-274fdea6b5a4?auto=format&fit=crop&w=1200&q=80',
      'ë¼ë„Œí˜ëŸ¬ìŠ¤': 'https://images.unsplash.com/photo-1491591462767-3b5599491cf1?auto=format&fit=crop&w=1200&q=80',
      'ë¦¬ì‹œì•ˆì…”ìŠ¤': 'https://images.unsplash.com/photo-1525310072745-f49212b5ac6d?auto=format&fit=crop&w=1200&q=80',
      'ê±°ë² ë¼': 'https://images.unsplash.com/photo-1447875569765-2b3db822bec9?auto=format&fit=crop&w=1200&q=80',
      'ì¹´ë¼': 'https://images.unsplash.com/photo-1462275646964-a0e3386b89fa?auto=format&fit=crop&w=1200&q=80',
      'ì•„ë„¤ëª¨ë„¤': 'https://images.unsplash.com/photo-1494336934272-fd4f0f0c35b3?auto=format&fit=crop&w=1200&q=80',
      'í•´ë°”ë¼ê¸°': 'https://images.unsplash.com/photo-1470509037663-253afd7f0f51?auto=format&fit=crop&w=1200&q=80',
      'ì•ŒìŠ¤íŠ¸ë¡œë©”ë¦¬ì•„': 'https://images.unsplash.com/photo-1455659817273-f96807779a8a?auto=format&fit=crop&w=1200&q=80'
    };

    function fallbackSampleImage(concept){
      const safe = escapeHtml(concept || 'ì¶”ì²œ ì»¨ì…‰');
      const svg = `
<svg xmlns="http://www.w3.org/2000/svg" width="1200" height="800">
  <defs>
    <linearGradient id="g" x1="0" y1="0" x2="1" y2="1">
      <stop offset="0%" stop-color="#dcfce7"/>
      <stop offset="100%" stop-color="#bbf7d0"/>
    </linearGradient>
  </defs>
  <rect width="1200" height="800" fill="url(#g)"/>
  <text x="50%" y="48%" text-anchor="middle" font-size="44" font-family="sans-serif" fill="#166534">ìƒ˜í”Œ ì‚¬ì§„ ì¤€ë¹„ì¤‘</text>
  <text x="50%" y="56%" text-anchor="middle" font-size="34" font-family="sans-serif" fill="#166534">${safe}</text>
</svg>`;
      return `data:image/svg+xml;charset=UTF-8,${encodeURIComponent(svg)}`;
    }

    function pickFlowerPhoto(mainList){
      for(const f of (mainList || [])){
        const key = Object.keys(flowerPhotoByName).find(k => f.includes(k));
        if(key) return flowerPhotoByName[key];
      }
      return null;
    }

    function pickSamplePhoto(personality, mainList){
      return bouquetPhotoByPersonality[personality]
        || pickFlowerPhoto(mainList)
        || 'https://images.unsplash.com/photo-1487070183336-b863922373d4?auto=format&fit=crop&w=1200&q=80';
    }

    const state = {
      relation:null,
      occasion:null,
      brightness:null,
      style:null,
      volume:null,
      taboos:[],
      urgency:null
    };

    function clearState(){
      state.relation = null;
      state.occasion = null;
      state.brightness = null;
      state.style = null;
      state.volume = null;
      state.taboos = [];
      state.urgency = null;
    }

    let stepIdx = 0;
    function currentStep(){ return steps[stepIdx]; }

    function setAnswer(stepId, value){
      if(stepId === 'taboos'){
        const v = value;
        const has = state.taboos.includes(v);

        if(v === 'ì—†ìŒ'){
          state.taboos = has ? [] : ['ì—†ìŒ'];
          return;
        }

        state.taboos = state.taboos.filter(x => x !== 'ì—†ìŒ');

        if(has) state.taboos = state.taboos.filter(x => x !== v);
        else state.taboos.push(v);
        return;
      }
      state[stepId] = value;
    }

    function getAnswer(stepId){
      if(stepId === 'taboos') return state.taboos;
      return state[stepId];
    }

    function canGoNext(){
      const s = currentStep();
      const ans = getAnswer(s.id);
      if(s.type === 'multi') return true;
      return !!ans;
    }

    function updateProgress(){
      $('stepText').textContent = `${stepIdx+1}/${steps.length}`;
      const pct = Math.round((stepIdx / (steps.length - 1)) * 100);
      $('barFill').style.width = `${pct}%`;

      $('stepHint').textContent = (currentStep().type === 'multi')
        ? 'ë³µìˆ˜ ì„ íƒ í›„ â€œë‹¤ìŒâ€'
        : 'ì„ íƒí•˜ë©´ ë‹¤ìŒìœ¼ë¡œ ë„˜ì–´ê°€ìš”';
    }

    function renderStep(){
      const s = currentStep();

      $('quizTitle').textContent = `Q${stepIdx+1}`;
      $('qText').textContent = `Q. ${s.title}`;   // âœ… Q. ë¶™ì´ê¸°
      $('qSub').textContent = s.sub || '';
      $('quizFootnote').textContent = s.footnote || '';

      updateProgress();

      $('btnBack').style.visibility = (stepIdx === 0) ? 'hidden' : 'visible';
      $('btnNext').style.display = (s.type === 'multi') ? 'inline-flex' : 'none';

      const opts = $('options');
      opts.innerHTML = '';
      opts.className = 'options ' + ((s.type === 'ab') ? 'two' : '');

      const selected = getAnswer(s.id);

      s.options.forEach((opt, idx)=>{
        const div = document.createElement('div');
        div.className = 'opt';

        const isSelected = (s.type === 'multi')
          ? (selected || []).includes(opt.value)
          : (selected === opt.value);

        div.dataset.selected = isSelected ? 'true' : 'false';

        // âœ… ABëŠ” ì‚¬ì§„ì²˜ëŸ¼ A./B. ë¼ë²¨ + ê°€ìš´ë° ì •ë ¬ ë°•ìŠ¤
        if(s.type === 'ab'){
          const letter = (idx === 0) ? 'A' : 'B';
          div.classList.add('abOpt');
          div.innerHTML = `
            <div class="abBadge">${letter}.</div>
            <div class="abTitle">${escapeHtml(opt.title)}</div>
            ${opt.desc ? `<div class="abDesc">${escapeHtml(opt.desc)}</div>` : ''}
          `;
        } else {
          div.innerHTML = `
            <div>
              <div class="title">${escapeHtml(opt.title)}</div>
              ${opt.desc ? `<div class="desc">${escapeHtml(opt.desc)}</div>` : ''}
            </div>
          `;
        }

        div.addEventListener('click', ()=>{
          setAnswer(s.id, opt.value);
          renderStep();
          if(s.type !== 'multi') setTimeout(()=>goNext(), 120);
        });

        opts.appendChild(div);
      });
    }

    function goNext(){
      if(!canGoNext()){
        alert('ì´ ì§ˆë¬¸ì—ì„œ í•˜ë‚˜ë¥¼ ì„ íƒí•´ì¤˜!');
        return;
      }
      if(stepIdx < steps.length - 1){
        stepIdx += 1;
        renderStep();
      }else{
        showResult();
      }
    }

    function goBack(){
      if(stepIdx > 0){
        stepIdx -= 1;
        renderStep();
      }
    }

    function resetAll(){
      clearState();
      stepIdx = 0;
      history.replaceState(null, '', location.pathname);
      showScreen('screenStart');
    }

    /* ===== ì•„ë˜ ë¡œì§(ê²°ê³¼ ìƒì„±)ì€ ë„ˆ ì½”ë“œ ê·¸ëŒ€ë¡œ ìœ ì§€ ===== */
    const profiles = {
      'ëŸ¬ë¸”ë¦¬': {
        concept: 'í•‘í¬ ë¬´ë“œ ëŸ¬ë¸”ë¦¬',
        mood: ['ë”°ëœ»', 'ì‚¬ë‘ìŠ¤ëŸ¬ì›€', 'ë¶€ë“œëŸ¬ì›€'],
        tone: 'í•‘í¬/í¬ë¦¼/ì—°í•œ ì½”ë„ ì¤‘ì‹¬',
        wrap: 'íŒŒìŠ¤í…” í¬ì¥ + ì–‡ì€ ë¦¬ë³¸(ê³¼í•˜ì§€ ì•Šê²Œ)',
        flowers: { main: ['íŠ¤ë¦½','ë¼ë„Œí˜ëŸ¬ìŠ¤','ë¦¬ì‹œì•ˆì…”ìŠ¤(ìœ ìŠ¤í† ë§ˆ)','ê±°ë² ë¼(í•‘í¬)'], sub: ['ìŠ¤í”„ë ˆì´ ì¹´ë„¤ì´ì…˜','ì•ŒìŠ¤íŠ¸ë¡œë©”ë¦¬ì•„'], texture: ['ìœ ì¹¼ë¦½íˆ¬ìŠ¤','ì™ìŠ¤í”Œë¼ì›Œ'] },
        meaning: 'â€˜ë‹¤ì •í•¨â€™ê³¼ â€˜ì„¤ë ˜â€™ ë¬´ë“œ'
      },
      'ì„¸ë ¨ë¨': {
        concept: 'ë„ì‹œì  ë¯¸ë‹ˆ ì‹œí¬',
        mood: ['ê¹”ë”', 'ì„¸ë ¨', 'ì •ëˆ'],
        tone: 'í™”ì´íŠ¸/ê·¸ë¦° + í†¤ë‹¤ìš´ í¬ì¸íŠ¸',
        wrap: 'ë¬´ê´‘ ì¢…ì´ + í†¤ë‹¤ìš´ í¬ì¥(ì •ëˆëœ ëŠë‚Œ)',
        flowers: { main: ['ë¦¬ì‹œì•ˆì…”ìŠ¤(í™”ì´íŠ¸)','ì¹´ë¼(ì¹¼ë¼)','ì•„ë„¤ëª¨ë„¤','íŠ¤ë¦½(í™”ì´íŠ¸)'], sub: ['ì•ŒìŠ¤íŠ¸ë¡œë©”ë¦¬ì•„','ìŠ¤ì¹´ë¹„ì˜¤ì‚¬'], texture: ['ìœ ì¹¼ë¦½íˆ¬ìŠ¤','ëŸ¬ìŠ¤ì»¤ìŠ¤(ê·¸ë¦°)'] },
        meaning: 'â€˜ì¡´ì¤‘â€™ê³¼ â€˜ì„¼ìŠ¤â€™ ë¬´ë“œ'
      },
      'ê·€ì—¬ì›€': {
        concept: 'ìƒí¼ ë°œë„ íŒ',
        mood: ['ë°œë„', 'ëª…ë‘', 'ê·€ì—¬ì›€'],
        tone: 'ë°ì€ ì»¬ëŸ¬(ì˜ë¡œ/í•‘í¬/ë¼ì´íŠ¸ ì˜¤ë Œì§€) 1~2ìƒ‰',
        wrap: 'ì»¬ëŸ¬ í¬ì¸íŠ¸ í¬ì¥(ê³¼í•˜ì§€ ì•Šê²Œ)',
        flowers: { main: ['ê±°ë² ë¼','íŠ¤ë¦½','ë¼ë„Œí˜ëŸ¬ìŠ¤'], sub: ['ì•ŒìŠ¤íŠ¸ë¡œë©”ë¦¬ì•„','ìŠ¤í”„ë ˆì´ ì¹´ë„¤ì´ì…˜'], texture: ['ìœ ì¹¼ë¦½íˆ¬ìŠ¤','ì™ìŠ¤í”Œë¼ì›Œ'] },
        meaning: 'â€˜ê¸°ë¶„ ì—…â€™ê³¼ â€˜ì‘ì›â€™ ë¬´ë“œ'
      },
      'ë¯¸ë‹ˆë©€': {
        concept: 'ì‹¬í”Œ ë‹´ë°± ì›í†¤',
        mood: ['ì‹¬í”Œ', 'ë‹´ë°±', 'ì°¨ë¶„'],
        tone: 'ì›í†¤(í™”ì´íŠ¸/í¬ë¦¼/ì—°í•‘í¬ ì¤‘ 1) + ê·¸ë¦° ìµœì†Œ',
        wrap: 'ë¬´ê´‘/í¬ë¼í”„íŠ¸ ê³„ì—´ + ë¦¬ë³¸ ìµœì†Œ',
        flowers: { main: ['ë¦¬ì‹œì•ˆì…”ìŠ¤(ìœ ìŠ¤í† ë§ˆ)','íŠ¤ë¦½','ì•„ë„¤ëª¨ë„¤'], sub: ['ì•ŒìŠ¤íŠ¸ë¡œë©”ë¦¬ì•„'], texture: ['ìœ ì¹¼ë¦½íˆ¬ìŠ¤','ëŸ¬ìŠ¤ì»¤ìŠ¤(ê·¸ë¦°)'] },
        meaning: 'â€˜í¸ì•ˆí•¨â€™ê³¼ â€˜ì •ì„±â€™ ë¬´ë“œ'
      },
      'ìš°ì•„í•¨': {
        concept: 'ì°¨ë¶„í•œ ê³ ê¸‰ ë¬´ë“œ',
        mood: ['ìš°ì•„', 'ì°¨ë¶„', 'ê³ ê¸‰'],
        tone: 'í¬ë¦¼/í™”ì´íŠ¸/í†¤ë‹¤ìš´ í•‘í¬ + ê·¸ë¦°',
        wrap: 'í†¤ë‹¤ìš´ í¬ì¥ + ê³ ê¸‰ìŠ¤ëŸ¬ìš´ ë¦¬ë³¸(ê³¼í•˜ì§€ ì•Šê²Œ)',
        flowers: { main: ['ë¦¬ì‹œì•ˆì…”ìŠ¤(ìœ ìŠ¤í† ë§ˆ)','ë¼ë„Œí˜ëŸ¬ìŠ¤','íŠ¤ë¦½'], sub: ['ìŠ¤ì¹´ë¹„ì˜¤ì‚¬','ì•ŒìŠ¤íŠ¸ë¡œë©”ë¦¬ì•„'], texture: ['ìœ ì¹¼ë¦½íˆ¬ìŠ¤','ì™ìŠ¤í”Œë¼ì›Œ'] },
        meaning: 'â€˜í’ˆê²©â€™ê³¼ â€˜ì¡´ì¤‘â€™ ë¬´ë“œ'
      },
      'í™œê¸°': {
        concept: 'ë°ì€ ì—ë„ˆì§€ ì—…',
        mood: ['ì—ë„ˆì§€', 'ë°ìŒ', 'í™œê¸°'],
        tone: 'ì˜ë¡œ/ë¼ì´íŠ¸ ì˜¤ë Œì§€ + í™”ì´íŠ¸ë¡œ ì •ë¦¬',
        wrap: 'ë°ì€ í¬ì¸íŠ¸ í¬ì¥ + ê¹”ë”í•œ ë§ˆê°',
        flowers: { main: ['í•´ë°”ë¼ê¸°','ê±°ë² ë¼','íŠ¤ë¦½'], sub: ['ì•ŒìŠ¤íŠ¸ë¡œë©”ë¦¬ì•„','ìŠ¤í”„ë ˆì´ ì¹´ë„¤ì´ì…˜'], texture: ['ìœ ì¹¼ë¦½íˆ¬ìŠ¤','ëŸ¬ìŠ¤ì»¤ìŠ¤(ê·¸ë¦°)'] },
        meaning: 'â€˜ì‘ì›â€™ê³¼ â€˜ê¸°ë¶„ì „í™˜â€™ ë¬´ë“œ'
      }
    };

    const tabooBans = {
      'í–¥ ê°•í•œ ê½ƒì€ ì‹«ì–´í•¨': ['ë°±í•©','í”„ë¦¬ì§€ì•„','íˆì•„ì‹ ìŠ¤','ìŠ¤í†¡'],
      'ì¥ë¯¸ëŠ” ì‹«ì–´í•¨': ['ì¥ë¯¸','ìŠ¤í”„ë ˆì´ì¥ë¯¸']
    };

    const occasionReason = {
      'ìƒì¼':'ìƒì¼ì€ â€˜ì¶•í•˜â€™ê°€ ì¤‘ì‹¬. ë°ê³  ê¸°ë¶„ ì¢‹ì•„ì§€ëŠ” ë¬´ë“œê°€ ì•ˆì „í•´ìš”.',
      'ê¸°ë…ì¼':'ê¸°ë…ì¼ì€ â€˜ê´€ê³„ì˜ í™•ì‹ â€™ì´ í¬ì¸íŠ¸. ê³¼í•˜ì§€ ì•Šê²Œ ì„¼ìŠ¤ê°€ ì¢‹ì•„ìš”.',
      'ì‚¬ê³¼(ë¯¸ì•ˆí•´)':'ì‚¬ê³¼ëŠ” â€˜ë¶€ë‹´â€™ë³´ë‹¤ â€˜ì§„ì‹¬â€™. í†¤ë‹¤ìš´ + ë‹´ë°±ì´ ì œì¼ ì•ˆì •ì ì´ì—ìš”.',
      'ì¶•í•˜(í•©ê²©/ìŠ¹ì§„/ìƒˆì¶œë°œ)':'ì¶•í•˜ëŠ” â€˜ì‘ì›/ìë¶€ì‹¬â€™. ê¹”ë”í•œë° í˜ ìˆëŠ” ì¡°í•©ì´ ì¢‹ì•„ìš”.',
      'ì²« ì„ ë¬¼':'ì²« ì„ ë¬¼ì€ â€˜ì•ˆì „í•˜ê²Œ í˜¸ê°â€™. ì·¨í–¥ ì¡´ì¤‘ í†¤ì´ ë‹µì´ì—ìš”.',
      'ê·¸ëƒ¥(ê³ ë§™ê³  ì‘ì›)':'ê·¸ëƒ¥ ì£¼ëŠ” ê±´ â€˜ì¼ìƒì— ì •ì„±â€™. ë©˜íŠ¸ í•œ ì¤„ì´ë©´ ì„¼ìŠ¤ ì™„ì„±.'
    };

    function mapPersonality(brightness, style, volume){
      const key = `${brightness}|${style}|${volume}`;
      const table = {
        'bright|cute|lush':'ê·€ì—¬ì›€',
        'bright|cute|simple':'ëŸ¬ë¸”ë¦¬',
        'bright|chic|simple':'ì„¸ë ¨ë¨',
        'bright|chic|lush':'í™œê¸°',
        'calm|chic|simple':'ë¯¸ë‹ˆë©€',
        'calm|chic|lush':'ìš°ì•„í•¨',
        'calm|cute|simple':'ëŸ¬ë¸”ë¦¬',
        'calm|cute|lush':'ìš°ì•„í•¨'
      };
      return table[key] || 'ì„¸ë ¨ë¨';
    }

    function pickFlowers(profile, taboos){
      let banned = [];
      (taboos || []).forEach(t => { if(tabooBans[t]) banned = banned.concat(tabooBans[t]); });
      banned = Array.from(new Set(banned));

      const mainCandidates = profile.flowers.main.filter(f => !banned.some(b => f.includes(b)));
      const subCandidates = profile.flowers.sub.filter(f => !banned.some(b => f.includes(b)));
      const texCandidates = profile.flowers.texture.filter(f => !banned.some(b => f.includes(b)));

      const fallbackMain = ['ë¦¬ì‹œì•ˆì…”ìŠ¤(ìœ ìŠ¤í† ë§ˆ)','íŠ¤ë¦½','ë¼ë„Œí˜ëŸ¬ìŠ¤','ê±°ë² ë¼'].filter(f => !banned.some(b => f.includes(b)));
      const fallbackSub = ['ì•ŒìŠ¤íŠ¸ë¡œë©”ë¦¬ì•„','ìŠ¤í”„ë ˆì´ ì¹´ë„¤ì´ì…˜'].filter(f => !banned.some(b => f.includes(b)));
      const fallbackTex = ['ìœ ì¹¼ë¦½íˆ¬ìŠ¤','ëŸ¬ìŠ¤ì»¤ìŠ¤(ê·¸ë¦°)','ì™ìŠ¤í”Œë¼ì›Œ'].filter(f => !banned.some(b => f.includes(b)));

      const main = (mainCandidates.length ? mainCandidates : fallbackMain).slice(0,2);
      const sub = (subCandidates.length ? subCandidates : fallbackSub).slice(0,2);
      const tex = (texCandidates.length ? texCandidates : fallbackTex).slice(0,2);

      return { main, sub, tex };
    }

    function buildMessages({relation, occasion}){
      const base = {
        'ì¸/ì†Œê°œíŒ…': {
          simple: 'ë„ˆí•œí…Œ ì–´ìš¸ë¦´ ê²ƒ ê°™ì•„ì„œ ë“¤ê³  ì™”ì–´.',
          sense: 'ë¬´ë“œê°€ ë”± ë„ˆë¼ì„œ ê³¨ë¼ë´¤ì–´ ğŸ™‚',
          sincere: 'ë¶€ë‹´ ì—†ì´ ë°›ì•„ì¤˜. ê¸°ë¶„ ì¢‹ì•„ì¡Œìœ¼ë©´!'
        },
        'ì—¬ìì¹œêµ¬(ì—°ì¸)': {
          simple: 'ë„¤ ì·¨í–¥ ìª½ìœ¼ë¡œ ì±™ê²¨ì™”ì–´.',
          sense: 'ì´ ëŠë‚Œ, ë„ˆí•œí…Œ ê½¤ ì˜ ì–´ìš¸ë¦´ ë“¯ ğŸ™‚',
          sincere: 'ìš”ì¦˜ ê³ ë§ˆìš´ ê²Œ ë§ì•„ì„œ, ì´ë ‡ê²Œ ì „í•˜ê³  ì‹¶ì—ˆì–´.'
        },
        'ì•„ë‚´/ë°°ìš°ì': {
          simple: 'ì´ê±¸ë¡œ ê³ ë§ˆì›€ ì „í• ê²Œ.',
          sense: 'ë‹¹ì‹  ìŠ¤íƒ€ì¼ë¡œ ì •ë¦¬í•´ì„œ ë¶€íƒí•´ë´¤ì–´ ğŸ™‚',
          sincere: 'ëŠ˜ ë“ ë“ í•˜ê³  ê³ ë§ˆì›Œ. ê½ƒìœ¼ë¡œ ë§ˆìŒ ì „í• ê²Œ.'
        },
        'ì¹œêµ¬/ë™ë£Œ': {
          simple: 'ìˆ˜ê³ í–ˆì–´. ì´ê±° ë°›ì•„!',
          sense: 'ìš”ì¦˜ ë¶„ìœ„ê¸°ë‘ ë§ì¶°ì„œ í”½í–ˆì–´ ğŸ™‚',
          sincere: 'ì‘ì›í•˜ëŠ” ë§ˆìŒì´ì•¼. ì˜ í’€ë¦¬ê¸¸!'
        }
      };

      const tails = {
        'ìƒì¼': { simple:' ì˜¤ëŠ˜ì€ ë„ˆ ì£¼ì¸ê³µ.', sense:' ë„¤ ë‚ ì´ë‹ˆê¹Œ ì±™ê²¨ì•¼ì§€ ğŸ™‚', sincere:' ì˜¬ í•œ í•´ë„ ì¢‹ì€ ì¼ë§Œ ê°€ë“í•˜ê¸¸!' },
        'ê¸°ë…ì¼': { simple:' ê·¸ëƒ¥ ë„˜ì–´ê°€ë©´ ì„­í•˜ì§€.', sense:' ê¸°ë…ì¼ì´ë¼ í™•ì‹¤íˆ ì±™ê¹€ ğŸ™‚', sincere:' ìš°ë¦¬ ì•ìœ¼ë¡œë„ ê³„ì† ì˜ ì§€ë‚´ì.' },
        'ì‚¬ê³¼(ë¯¸ì•ˆí•´)': { simple:' ë‚´ê°€ ì¢€ ë” ì‹ ê²½ ì“¸ê²Œ.', sense:' ë§ë¡œë§Œ ë§ê³  í–‰ë™ìœ¼ë¡œ ë³´ì—¬ì¤„ê²Œ ğŸ™‚', sincere:' ë¯¸ì•ˆí•´. ë§ˆìŒ í’€ë ¸ìœ¼ë©´ ì¢‹ê² ë‹¤.' },
        'ì¶•í•˜(í•©ê²©/ìŠ¹ì§„/ìƒˆì¶œë°œ)': { simple:' ì§„ì§œ ë©‹ì¡Œë‹¤.', sense:' ì´ëŸ° ë‚ ì€ ê½ƒì´ êµ­ë£° ğŸ™‚', sincere:' ì•ìœ¼ë¡œ ë” ì˜ ë  ê±°ì•¼. ì§„ì‹¬ìœ¼ë¡œ ì¶•í•˜í•´.' },
        'ì²« ì„ ë¬¼': { simple:' ì²« ê½ƒì´ë¼ ë¬´ë‚œí•˜ê²Œ ì‹œì‘!', sense:' ì²˜ìŒì´ë¼ ë” ê³ ë¯¼í–ˆì–´ ğŸ™‚', sincere:' ë¶€ë‹´ì€ ë§ê³ , ê·¸ëƒ¥ ë‚´ ë§ˆìŒì´ë¼ê³  ìƒê°í•´ì¤˜.' },
        'ê·¸ëƒ¥(ê³ ë§™ê³  ì‘ì›)': { simple:' ì´ìœ  ì—†ì–´ë„ ë˜ëŠ” ë‚ ì´ì–ì•„.', sense:' ê·¸ëƒ¥ ì£¼ê³  ì‹¶ì–´ì„œ ë“¤ê³  ì™”ì§€ ğŸ™‚', sincere:' ìš”ì¦˜ ê³ ìƒ ë§ì•„ì„œ, ê¸°ë¶„ ì „í™˜ í–ˆìœ¼ë©´!' }
      };

      const rel = base[relation] || base['ì—¬ìì¹œêµ¬(ì—°ì¸)'];
      const tail = tails[occasion] || {simple:'', sense:'', sincere:''};

      return {
        simple: rel.simple + (tail.simple || ''),
        sense: rel.sense + (tail.sense || ''),
        sincere: rel.sincere + (tail.sincere || '')
      };
    }

    function buildCautions({taboos, urgency}){
      const t = (taboos || []).filter(x => x !== 'ì—†ìŒ');
      const cautions = [];

      if(t.includes('í–¥ ê°•í•œ ê½ƒì€ ì‹«ì–´í•¨')) cautions.push('í–¥ì´ ê°•í•œ ê½ƒ(ì˜ˆ: ë°±í•©/í”„ë¦¬ì§€ì•„ ë“±)ì€ í”¼í•˜ëŠ” ë°©í–¥ìœ¼ë¡œ ìš”ì²­í•˜ë©´ ì¢‹ì•„ìš”.');
      if(t.includes('ì¥ë¯¸ëŠ” ì‹«ì–´í•¨')) cautions.push('ì¥ë¯¸/ìŠ¤í”„ë ˆì´ì¥ë¯¸ëŠ” ì œì™¸ ìš”ì²­ì„ ê¼­ ë„£ì–´ì£¼ì„¸ìš”.');
      if(t.includes('í™”ë ¤í•œ ê±´ ë¶€ë‹´')) cautions.push('ìƒ‰ì„ 1~2í†¤ìœ¼ë¡œ ì œí•œí•˜ê³ , í¬ì¥ë„ ê³¼í•˜ì§€ ì•Šê²Œ ìš”ì²­í•˜ëŠ” ê²Œ ì•ˆì „í•´ìš”.');
      if(t.includes('ì•Œë ˆë¥´ê¸°/ë¯¼ê° ìˆìŒ')) cautions.push('ë¯¼ê°/ì•Œë ˆë¥´ê¸° ìˆìœ¼ë©´ ê½ƒê°€ë£¨Â·í–¥ ìµœì†Œ êµ¬ì„±ìœ¼ë¡œ ìš”ì²­í•˜ëŠ” ê²Œ ì¢‹ì•„ìš”.');

      if(urgency === 'ì˜¤ëŠ˜(ë‹¹ì¼)') cautions.push('ì˜¤ëŠ˜ì´ë©´ ë””í…Œì¼ë³´ë‹¤ â€œë¬´ë“œ ìœ ì§€ + ì¬ê³  ìœ„ì£¼â€ê°€ í˜„ì‹¤ì ì¸ ë‹µì´ì—ìš”.');
      else if(urgency === 'ë‚´ì¼') cautions.push('ë‚´ì¼ì´ë©´ ì›í•˜ëŠ” í†¤ì€ ê°€ëŠ¥í•˜ì§€ë§Œ, í’ˆì ˆ ì‹œ ëŒ€ì²´ ê°€ëŠ¥ ë¬¸ì¥ì„ ë„£ì–´ì£¼ì„¸ìš”.');
      else cautions.push('ì—¬ìœ  ìˆìœ¼ë©´ ì›í•˜ëŠ” ê½ƒì„ â€œê°€ëŠ¥í•˜ë©´â€ í¬í•¨í•´ë‹¬ë¼ê³  ë¶€ë“œëŸ½ê²Œ ìš”ì²­í•´ë„ ì¢‹ì•„ìš”.');

      if(cautions.length === 0) cautions.push('ê¸ˆê¸°ë§Œ ì—†ìœ¼ë©´ ë¬´ë“œ/í†¤ë§Œ ì˜ ì¡ì•„ë„ ì‹¤íŒ¨ í™•ë¥ ì´ í™• ë‚®ì•„ì ¸ìš”.');
      return cautions;
    }

    function showResult(){
      const taboos = (state.taboos || []).includes('ì—†ìŒ') ? [] : (state.taboos || []);
      const personality = mapPersonality(state.brightness, state.style, state.volume);
      const profile = profiles[personality];
      const line = sisterLines[Math.floor(Math.random() * sisterLines.length)];

      const { main, sub, tex } = pickFlowers(profile, taboos);
      const msgs = buildMessages({relation: state.relation, occasion: state.occasion});
      const cautions = buildCautions({taboos, urgency: state.urgency});

      let tone = profile.tone;
      let wrap = profile.wrap;

      if(taboos.includes('í™”ë ¤í•œ ê±´ ë¶€ë‹´')){
        tone += ' (í†¤ 1~2ê°œë¡œ ì œí•œ ì¶”ì²œ)';
        wrap += ' (í¬ì¥/ë¦¬ë³¸ ìµœì†Œí™” ì¶”ì²œ)';
      }

      const reasonParts = [
        `ê´€ê³„: ${state.relation || 'ë¯¸ì„ íƒ'}`,
        `ìƒí™©: ${state.occasion || 'ë¯¸ì„ íƒ'}`,
        occasionReason[state.occasion] || '',
        `ì„ íƒí•œ ë¬´ë“œëŠ” â€œ${state.brightness === 'bright' ? 'í™”ì‚¬' : 'ì°¨ë¶„'} / ${state.style === 'cute' ? 'ê·€ì—¬ì›€' : 'ì„¸ë ¨'} / ${state.volume === 'simple' ? 'ì‹¬í”Œ' : 'í’ì„±'}â€ ìª½!`
      ].filter(Boolean);

      const meaning = `${profile.meaning} (ìƒí™©: ${state.occasion || 'ë¯¸ì„ íƒ'})`;
      const substitution = 'ë©”ì¸ ê½ƒ í’ˆì ˆ ì‹œ ë¹„ìŠ·í•œ í†¤/ê²°ë¡œ ëŒ€ì²´ ê°€ëŠ¥(ë¬´ë“œ ìœ ì§€).';
      const palette = paletteByPersonality[personality] || paletteByPersonality['ì„¸ë ¨ë¨'];
      const sampleImage = pickSamplePhoto(personality, main);
      const sampleImageFallback = pickFlowerPhoto(main) || fallbackSampleImage(profile.concept);
      const sampleImageFallbackFinal = fallbackSampleImage(profile.concept);
      const moodText = `${state.style === 'cute' ? 'ëŸ¬ë¸”ë¦¬/ë°œë„' : 'ê¹”ë”/ì„¸ë ¨'} Â· ${state.volume === 'simple' ? 'ì‹¬í”Œ' : 'í’ì„±'}`;
      const floristOrder = 'ì˜¤ëŠ˜/ë‚´ì¼ í”½ì—… ê°€ëŠ¥í•˜ë©´, í™”ì´íŠ¸+ê·¸ë¦° í†¤ì˜ ë¯¸ë‹ˆë©€ ë¶€ì¼€ë¡œ ë¶€íƒë“œë ¤ìš”. ì¥ë¯¸ ì œì™¸. ë©”ì¸ ê½ƒ í’ˆì ˆì´ë©´ ë¹„ìŠ·í•œ í†¤ìœ¼ë¡œ ëŒ€ì²´ ê°€ëŠ¥.';
      const shareForGirlfriend = 'ë‚´ ë‚¨ì¹œ ì•Œê³ ë¦¬ì¦˜ì— ì´ê±° ë– ë¼ ã…‹ã…‹';

      const shareState = {...state, taboos};
      const code = base64UrlEncode(shareState);
      const url = new URL(location.href);
      url.searchParams.set('r', code);
      history.replaceState(null, '', url.toString());

      const resultHtml = `
        <div class="hero">
          <h1>ê½ƒì„ ë§Œì§€ëŠ” ëˆ„ë‚˜ì˜ ê²°ë¡ </h1>
          <p class="muted">${escapeHtml(line)}</p>
          <div class="mini">ê²°ê³¼ ì„±í–¥: <b>${escapeHtml(personality)}</b></div>
        </div>

        <div class="box">
          <div class="top3">
            <div class="topItem">âœ… ì˜¤ëŠ˜ì€ ì´ ì»¨ì…‰: ${escapeHtml(profile.concept)}</div>
            <div class="topItem">âœ… ìƒ‰ê°: ${escapeHtml(tone)} / ëŠë‚Œ: ${escapeHtml(moodText)}</div>
            <div class="topItem">
              âœ… ë°”ë¡œ ì£¼ë¬¸: ê½ƒì§‘ì— ë³´ë‚´ê¸°
              <small>ë²„íŠ¼ ëˆ„ë¥´ë©´ ì£¼ë¬¸ ë¬¸ì¥ì„ ë³µì‚¬í•´ì¤˜ìš”.</small>
              <div class="btnrow" style="margin-top:8px;">
                <button id="btnCopyOrder">ê½ƒì§‘ì— ë³´ë‚´ê¸°(ì£¼ë¬¸ë¬¸ì¥ ë³µì‚¬)</button>
              </div>
            </div>
          </div>
        </div>

        <div class="box">
          <h3>ì¶”ì²œ ì»¨ì…‰</h3>
          <div class="samplePhoto">
            <img
              src="${escapeHtml(sampleImage)}"
              alt="${escapeHtml(profile.concept)} ìƒ˜í”Œ ì‚¬ì§„"
              loading="lazy"
              referrerpolicy="no-referrer"
              onerror="if(!this.dataset.err1){this.dataset.err1='1';this.src='${escapeHtml(sampleImageFallback)}';}else{this.onerror=null;this.src='${escapeHtml(sampleImageFallbackFinal)}';}"
            />
            <div class="cap">ìƒ˜í”Œ ì‚¬ì§„: ${escapeHtml(profile.concept)} ì‹¤ì œ ê½ƒë‹¤ë°œ/ê½ƒ ì°¸ê³ ìš©</div>
          </div>
          <div class="palette">
            ${palette.map(p => `
              <div class="swatch">
                <div class="swatchColor" style="background:${escapeHtml(p.hex)};"></div>
                <div class="swatchMeta">${escapeHtml(p.name)}<br/>${escapeHtml(p.hex)}</div>
              </div>
            `).join('')}
          </div>
          <div class="chips">
            <span class="chip">ì»¨ì…‰: <b>${escapeHtml(profile.concept)}</b></span>
            ${profile.mood.map(m => `<span class="chip">${escapeHtml(m)}</span>`).join('')}
          </div>
          <div class="divider"></div>
          <div class="muted" style="font-size:13px;">
            í†¤/ìƒ‰ê°: <b>${escapeHtml(tone)}</b><br/>
            í¬ì¥: <b>${escapeHtml(wrap)}</b>
          </div>
        </div>

        <div class="box">
          <h3>ì¶”ì²œ ê½ƒ ì¡°í•© <span class="muted" style="font-size:12px;">(ê³„ì ˆ/ì¬ê³ ì— ë”°ë¼ ë³€ê²½ ê°€ëŠ¥)</span></h3>
          <ul class="list">
            <li><b>ë©”ì¸</b>: ${main.map(escapeHtml).join(' / ')}</li>
            <li><b>ì„œë¸Œ</b>: ${sub.map(escapeHtml).join(' / ')}</li>
            <li><b>ì§ˆê°/ê·¸ë¦°</b>: ${tex.map(escapeHtml).join(' / ')}</li>
          </ul>
          <div class="divider"></div>
          <div class="muted" style="font-size:13px;"><b>ëŒ€ì²´ ê·œì¹™</b>: ${escapeHtml(substitution)}</div>
        </div>

        <div class="box">
          <h3>ì™œ ì´ê²Œ ë§ëƒë©´</h3>
          <details class="explain">
            <summary>ì ‘ê¸°/í¼ì¹˜ê¸°</summary>
            <p>${reasonParts.map(escapeHtml).join(' ')}</p>
          </details>
        </div>

        <div class="box">
          <h3>ê½ƒ ì˜ë¯¸ í•œ ì¤„</h3>
          <p style="margin:0; font-size:14px;"><b>${escapeHtml(meaning)}</b></p>
          <div class="footnote">â€» ê½ƒë§ì€ í•´ì„ì´ ì—¬ëŸ¬ ê°€ì§€ì¼ ìˆ˜ ìˆì–´ìš”.</div>
        </div>

        <div class="box">
          <h3>ê½ƒì§‘ DMìš© ì£¼ë¬¸ë¬¸ì¥(ë¬´ë£Œ 1ê°œ)</h3>
          <p style="margin:0; font-size:13px; font-weight:700;">${escapeHtml(floristOrder)}</p>
          <div class="btnrow">
            <button class="secondary" id="btnCopyOrderInline">ì£¼ë¬¸ë¬¸ì¥ ë³µì‚¬</button>
          </div>
        </div>

        <div class="box">
          <h3>ë°”ë¡œ ì¨ë¨¹ëŠ” ë©˜íŠ¸ 3ê°œ</h3>
          <ol class="list">
            <li>${escapeHtml(msgs.simple)}</li>
            <li>${escapeHtml(msgs.sense)}</li>
            <li>${escapeHtml(msgs.sincere)}</li>
          </ol>
          <div class="btnrow">
            <button class="secondary" id="btnCopyMent">ë©˜íŠ¸ 3ê°œ ë³µì‚¬</button>
            <button class="secondary" id="btnCopyLink">ê²°ê³¼ ë§í¬ ë³µì‚¬</button>
            <button class="secondary" id="btnCopyShareForHer">ì—¬ì¹œí•œí…Œ ê³µìœ ë¬¸êµ¬ ë³µì‚¬</button>
          </div>
          <div class="footnote">ê³µìœ  ë¬¸êµ¬ ì˜ˆ: â€œì´ê±° í•´ë³´ê³  ê½ƒ ê³¨ë¼ì¤˜ ğŸ˜‚â€ (ì¶œì²˜ ì—†ìŒ)</div>
        </div>

        <div class="box">
          <h3>ì£¼ì˜ì‚¬í•­</h3>
          <ul class="list">
            ${cautions.map(c=>`<li>${escapeHtml(c)}</li>`).join('')}
          </ul>
        </div>

        <div class="box ctaPro">
          <h3>PRO(ì˜ˆì •): ê½ƒì§‘ DM ì£¼ë¬¸ì„œ + ë©˜íŠ¸ 10ê°œ</h3>
          <p class="muted" style="margin:0; font-size:13px;">
            ë‹¤ìŒ ë‹¨ê³„ëŠ” â€œê½ƒì§‘ì— ê·¸ëŒ€ë¡œ ë³´ë‚´ë©´ ì œì‘ë˜ëŠ” ì£¼ë¬¸ì„œâ€ê¹Œì§€ ë½‘ì•„ì£¼ëŠ” ê±°ì•¼.
          </p>
        </div>

        <div class="btnrow" style="margin-top:16px;">
          <button id="btnAgain">ë‹¤ì‹œ í•˜ê¸°</button>
          <button class="secondary" id="btnHome">ì²˜ìŒìœ¼ë¡œ</button>
        </div>
      `;

      $('resultArea').innerHTML = resultHtml;

      $('btnCopyMent').onclick = async ()=>{
        const text = [msgs.simple, msgs.sense, msgs.sincere].join('\n');
        const ok = await copyText(text);
        toast(ok ? 'ë©˜íŠ¸ë¥¼ ë³µì‚¬í–ˆì–´!' : 'ë³µì‚¬ ì‹¤íŒ¨(ë¸Œë¼ìš°ì € ê¶Œí•œ í™•ì¸)');
      };
      $('btnCopyOrder').onclick = async ()=>{
        const ok = await copyText(floristOrder);
        toast(ok ? 'ì£¼ë¬¸ë¬¸ì¥ì„ ë³µì‚¬í–ˆì–´!' : 'ë³µì‚¬ ì‹¤íŒ¨(ë¸Œë¼ìš°ì € ê¶Œí•œ í™•ì¸)');
      };
      $('btnCopyOrderInline').onclick = async ()=>{
        const ok = await copyText(floristOrder);
        toast(ok ? 'ì£¼ë¬¸ë¬¸ì¥ì„ ë³µì‚¬í–ˆì–´!' : 'ë³µì‚¬ ì‹¤íŒ¨(ë¸Œë¼ìš°ì € ê¶Œí•œ í™•ì¸)');
      };

      $('btnCopyLink').onclick = async ()=>{
        const shareText = `ê½ƒì„ ë§Œì§€ëŠ” ëˆ„ë‚˜ ê²°ê³¼ ë§í¬: ${url.toString()}`;
        const ok = await copyText(shareText);
        toast(ok ? 'ê²°ê³¼ ë§í¬ë¥¼ ë³µì‚¬í–ˆì–´!' : 'ë³µì‚¬ ì‹¤íŒ¨(ë¸Œë¼ìš°ì € ê¶Œí•œ í™•ì¸)');
      };
      $('btnCopyShareForHer').onclick = async ()=>{
        const ok = await copyText(shareForGirlfriend);
        toast(ok ? 'ê³µìœ ë¬¸êµ¬ë¥¼ ë³µì‚¬í–ˆì–´!' : 'ë³µì‚¬ ì‹¤íŒ¨(ë¸Œë¼ìš°ì € ê¶Œí•œ í™•ì¸)');
      };

      $('btnAgain').onclick = ()=>{
        clearState();
        stepIdx = 0;
        showScreen('screenQuiz');
        renderStep();
      };

      $('btnHome').onclick = resetAll;

      showScreen('screenResult');
    }

    $('btnStart').addEventListener('click', ()=>{
      showScreen('screenQuiz');
      renderStep();
    });

    $('btnLoadExample').addEventListener('click', ()=>{
      state.relation = 'ì—¬ìì¹œêµ¬(ì—°ì¸)';
      state.occasion = 'ê¸°ë…ì¼';
      state.brightness = 'bright';
      state.style = 'chic';
      state.volume = 'simple';
      state.taboos = ['ì—†ìŒ'];
      state.urgency = 'ë‚´ì¼';
      showResult();
    });

    $('btnBack').addEventListener('click', goBack);
    $('btnNext').addEventListener('click', goNext);
    $('btnRestart').addEventListener('click', resetAll);

    (function initFromUrl(){
      const params = new URLSearchParams(location.search);
      const r = params.get('r');
      if(!r) return;

      try{
        const loaded = base64UrlDecode(r);
        const safeLoaded = sanitizeLoadedState(loaded);
        Object.assign(state, safeLoaded);
        showResult();
      }catch(e){
        history.replaceState(null, '', location.pathname);
      }
    })();
  </script>
</body>
</html>

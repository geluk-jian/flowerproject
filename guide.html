<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ëˆ„ë‚˜ì˜ ì „ì²´ ê°€ì´ë“œ | ê½ƒì„ ë§Œì§€ëŠ” ëˆ„ë‚˜</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+KR:wght@700;900&family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet" />
  <style>
    :root {
      --cream: #FDFAF5;
      --green: #3DB56A;
      --green-dark: #2D9A57;
      --green-light: #E8F7EE;
      --text-dark: #1A1A1A;
      --text-mid: #555;
      --text-light: #999;
      --border: #E8E8E8;
      --white: #FFFFFF;
      --gold: #C9A84C;
      --gold-light: #FDF8EE;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      background: var(--cream);
      font-family: 'Noto Sans KR', sans-serif;
      color: var(--text-dark);
      min-height: 100vh;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 20px;
      background: var(--cream);
      border-bottom: 1px solid var(--border);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .logo {
      font-size: 14px;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .back-btn {
      font-size: 13px;
      color: var(--text-mid);
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    main {
      max-width: 480px;
      margin: 0 auto;
      padding: 24px 20px 100px;
    }

    .hero-head {
      text-align: center;
      margin-bottom: 24px;
    }

    .badge-premium {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      background: var(--gold-light);
      color: var(--gold);
      border: 1px solid #E8D5A0;
      font-size: 12px;
      font-weight: 700;
      padding: 5px 12px;
      border-radius: 20px;
      margin-bottom: 12px;
    }

    .hero-head h1 {
      font-family: 'Noto Serif KR', serif;
      font-size: 24px;
      font-weight: 900;
      line-height: 1.4;
      color: var(--text-dark);
    }

    .hero-head h1 em {
      font-style: normal;
      color: var(--green);
    }

    .hero-head p {
      margin-top: 8px;
      font-size: 14px;
      color: var(--text-mid);
    }

    .items-card {
      background: var(--white);
      border-radius: 20px;
      overflow: hidden;
      box-shadow: 0 2px 16px rgba(0,0,0,0.06);
      margin-bottom: 16px;
    }

    .items-header {
      background: var(--green);
      padding: 14px 20px;
      color: white;
      font-size: 13px;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .item-row {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      padding: 16px 20px;
      border-bottom: 1px solid var(--border);
    }

    .item-row:last-child { border-bottom: none; }

    .item-icon {
      width: 36px;
      height: 36px;
      border-radius: 10px;
      background: var(--green-light);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      flex-shrink: 0;
    }

    .item-text strong {
      display: block;
      font-size: 15px;
      font-weight: 700;
      color: var(--text-dark);
      margin-bottom: 2px;
    }

    .item-text span {
      font-size: 12px;
      color: var(--text-light);
    }

    .preview-card {
      background: var(--white);
      border-radius: 20px;
      padding: 20px;
      margin-bottom: 16px;
      box-shadow: 0 2px 16px rgba(0,0,0,0.06);
    }

    .preview-title {
      font-size: 13px;
      font-weight: 700;
      color: var(--text-light);
      margin-bottom: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .preview-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    .preview-item {
      background: var(--cream);
      border-radius: 12px;
      padding: 14px;
      text-align: center;
    }

    .preview-item .p-emoji { font-size: 28px; margin-bottom: 6px; }
    .preview-item .p-label {
      font-size: 12px;
      color: var(--text-mid);
      font-weight: 500;
    }

    .palette-row {
      display: flex;
      gap: 8px;
      margin-top: 4px;
    }
    .palette-dot {
      flex: 1;
      height: 28px;
      border-radius: 8px;
    }

    .price-card {
      background: var(--white);
      border-radius: 20px;
      padding: 20px;
      margin-bottom: 16px;
      box-shadow: 0 2px 16px rgba(0,0,0,0.06);
      text-align: center;
    }

    .price-label {
      font-size: 13px;
      color: var(--text-light);
      margin-bottom: 6px;
    }

    .price-amount {
      font-family: 'Noto Serif KR', serif;
      font-size: 36px;
      font-weight: 900;
      color: var(--text-dark);
    }

    .price-amount span {
      font-size: 20px;
      font-weight: 700;
    }

    .price-desc {
      font-size: 12px;
      color: var(--text-light);
      margin-top: 6px;
    }

    .fixed-cta {
      position: fixed;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 100%;
      max-width: 480px;
      padding: 16px 20px;
      background: var(--cream);
      border-top: 1px solid var(--border);
    }

    .btn-pay {
      width: 100%;
      padding: 18px;
      background: var(--green);
      color: white;
      border: none;
      border-radius: 16px;
      font-size: 17px;
      font-weight: 700;
      cursor: pointer;
      font-family: 'Noto Sans KR', sans-serif;
      box-shadow: 0 4px 16px rgba(61,181,106,0.35);
      transition: background 0.2s, transform 0.1s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .btn-pay:active {
      background: var(--green-dark);
      transform: scale(0.98);
    }

    .btn-pay .price-tag {
      background: rgba(255,255,255,0.25);
      padding: 3px 10px;
      border-radius: 20px;
      font-size: 14px;
    }

    .result-card {
      display: none;
      background: var(--white);
      border-radius: 20px;
      padding: 20px;
      margin-bottom: 16px;
      box-shadow: 0 2px 16px rgba(0,0,0,0.06);
    }

    .result-card.show {
      display: block;
    }

    .result-head {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 10px;
    }

    .result-title {
      font-size: 16px;
      font-weight: 800;
      color: var(--text-dark);
    }

    .result-status {
      font-size: 12px;
      color: var(--text-light);
    }

    .result-body {
      font-size: 14px;
      color: var(--text-dark);
      line-height: 1.7;
      white-space: normal;
    }

    .result-body.loading {
      font-size: 14px;
      color: var(--text-mid);
    }

    .result-body.error {
      color: #C0392B;
    }

    .result-image {
      display: none;
      width: 100%;
      border-radius: 14px;
      margin-bottom: 12px;
      border: 1px solid var(--border);
      background: #fff;
      object-fit: cover;
      aspect-ratio: 1 / 1;
    }

    .result-image.show {
      display: block;
    }

    .result-section {
      display: block;
      font-weight: 800;
      margin-top: 12px;
      color: var(--text-dark);
    }

    .result-palette {
      margin: 12px 0 6px;
      padding: 10px;
      border: 1px solid var(--border);
      border-radius: 12px;
      background: #fff;
    }

    .result-palette-title {
      font-size: 12px;
      color: var(--text-mid);
      margin-bottom: 8px;
      font-weight: 700;
    }

    .result-palette .palette-row {
      margin-top: 0;
    }

    .result-palette-label {
      margin-top: 8px;
      font-size: 12px;
      color: var(--text-mid);
      font-weight: 700;
    }
  </style>
</head>
<body>
  <header>
    <div class="back-btn" onclick="history.back()">â† ê²°ê³¼ë¡œ ëŒì•„ê°€ê¸°</div>
    <div class="logo">ğŸŒ· ê½ƒì„ ë§Œì§€ëŠ” ëˆ„ë‚˜</div>
  </header>

  <main>
    <div class="hero-head">
      <div class="badge-premium">âœ¨ ëˆ„ë‚˜ì˜ ì „ì²´ ê°€ì´ë“œ</div>
      <h1>ë¬´ë£Œë³´ë‹¤<br><em>í›¨ì”¬ ë” ì±™ê²¨ì¤„ê²Œ.</em></h1>
      <p>ê½ƒë‹¤ë°œ ì™„ì„±ê¹Œì§€ ëˆ„ë‚˜ê°€ ëê¹Œì§€ ë„ì™€ì¤Œ</p>
    </div>

    <div class="items-card">
      <div class="items-header">ğŸŒ· ì´ëŸ° ê²Œ í¬í•¨ë¼ ìˆì–´</div>

      <div class="item-row">
        <div class="item-icon">ğŸ–¼ï¸</div>
        <div class="item-text">
          <strong>ê½ƒë‹¤ë°œ ì „ì²´ êµ¬ì„± (ì´ë¯¸ì§€)</strong>
          <span>ì‹¤ì œ ì–´ë–»ê²Œ ë§Œë“¤ì–´ì§€ëŠ”ì§€ ì´ë¯¸ì§€ë¡œ í™•ì¸</span>
        </div>
      </div>

      <div class="item-row">
        <div class="item-icon">ğŸ’¬</div>
        <div class="item-text">
          <strong>ìƒí™©ë³„ ë©˜íŠ¸ 5ê°œ</strong>
          <span>ë¬´ë£Œ 3ê°œë³´ë‹¤ ë” ë‹¤ì–‘í•˜ê²Œ, ê³¨ë¼ì„œ ì¨</span>
        </div>
      </div>

      <div class="item-row">
        <div class="item-icon">ğŸ“‹</div>
        <div class="item-text">
          <strong>ê½ƒì§‘ DM ê³ ê¸‰ ë²„ì „</strong>
          <span>ë” ìì„¸í•œ ì£¼ë¬¸ ë¬¸ì¥ìœ¼ë¡œ ì‹¤íŒ¨ í™•ë¥  0</span>
        </div>
      </div>

      <div class="item-row">
        <div class="item-icon">ğŸ¨</div>
        <div class="item-text">
          <strong>ì»¬ëŸ¬ íŒ”ë ˆíŠ¸ + í¬ì¥ ê°€ì´ë“œ</strong>
          <span>ê·¸ ì‚¬ëŒ ì·¨í–¥ì— ë§ëŠ” ìƒ‰ê°ê³¼ í¬ì¥ ìŠ¤íƒ€ì¼</span>
        </div>
      </div>
    </div>

    <div class="preview-card">
      <div class="preview-title">ë¯¸ë¦¬ë³´ê¸°</div>
      <div class="preview-grid">
        <div class="preview-item">
          <div class="p-emoji">ğŸ–¼ï¸</div>
          <div class="p-label">ê½ƒë‹¤ë°œ êµ¬ì„± ì´ë¯¸ì§€</div>
        </div>
        <div class="preview-item">
          <div class="p-emoji">ğŸ’¬</div>
          <div class="p-label">ìƒí™©ë³„ ë©˜íŠ¸ 5ê°œ</div>
        </div>
        <div class="preview-item">
          <div class="p-emoji">ğŸ“‹</div>
          <div class="p-label">ê½ƒì§‘ DM ê³ ê¸‰ë²„ì „</div>
        </div>
        <div class="preview-item">
          <div class="palette-row">
            <div class="palette-dot" style="background:#F2E0D0;"></div>
            <div class="palette-dot" style="background:#D4B8A0;"></div>
            <div class="palette-dot" style="background:#8B6F5E;"></div>
          </div>
          <div class="p-label" style="margin-top:8px;">ì»¬ëŸ¬ íŒ”ë ˆíŠ¸</div>
        </div>
      </div>
    </div>

    <div class="price-card">
      <div class="price-label">ì§€ê¸ˆ ë°”ë¡œ ë°›ì„ ìˆ˜ ìˆì–´</div>
      <div class="price-amount"><span>â‚©</span>1,900</div>
      <div class="price-desc">ì¼íšŒì„± ê²°ì œ Â· ê½ƒ ì¤„ ë•Œë§ˆë‹¤ ì“¸ ìˆ˜ ìˆì–´</div>
    </div>

    <section class="result-card" id="paidResultCard">
      <div class="result-head">
        <div class="result-title">ëˆ„ë‚˜ì˜ ìœ ë£Œ ê½ƒì¶”ì²œ ê²°ê³¼</div>
        <div class="result-status" id="paidResultStatus">ì¤€ë¹„ë¨</div>
      </div>
      <img id="paidResultImage" class="result-image" alt="ì¶”ì²œ ê½ƒë‹¤ë°œ ì´ë¯¸ì§€" loading="lazy" />
      <div class="result-body" id="paidResultBody"></div>
    </section>
  </main>

  <div class="fixed-cta">
    <button class="btn-pay" id="btnRunPaid">
      ëˆ„ë‚˜ì˜ ì „ì²´ ê°€ì´ë“œ ë°›ê¸°
      <span class="price-tag">1,900ì›</span>
    </button>
  </div>

  <script>
    function base64UrlDecode(str){
      const b64 = str.replace(/-/g,'+').replace(/_/g,'/');
      const pad = b64 + '==='.slice((b64.length + 3) % 4);
      const bin = atob(pad);
      const bytes = Uint8Array.from(bin, c => c.charCodeAt(0));
      const json = new TextDecoder().decode(bytes);
      return JSON.parse(json);
    }

    function getStateFromQuery(){
      const params = new URLSearchParams(location.search);
      const encoded = params.get('r');
      if (!encoded) return null;
      try {
        return base64UrlDecode(encoded);
      } catch (e) {
        return null;
      }
    }

    function buildPromptFromState(state){
      const payload = {
        relation: (state && state.relation) || 'ë¯¸ì„ íƒ',
        occasion: (state && state.occasion) || 'ë¯¸ì„ íƒ',
        style: (state && (state.style || state.personality)) || 'ë¯¸ì„ íƒ',
        palette: (state && state.palette) || 'ë¯¸ì„ íƒ',
        finish: (state && state.finish) || 'ë¯¸ì„ íƒ',
        photoHabit: (state && state.photoHabit) || 'ë¯¸ì„ íƒ',
        taboos: (state && (Array.isArray(state.taboos) ? state.taboos.join(', ') : (state.taboos || 'ì—†ìŒ'))) || 'ì—†ìŒ'
      };
      return [
        'ë‹¹ì‹ ì€ 10ë…„ì°¨ ê½ƒì§‘ ì‚¬ì¥ ëˆ„ë‚˜ì…ë‹ˆë‹¤.',
        'ì¹œí•œ ë‚¨ë™ìƒì—ê²Œ ë§í•˜ë“¯ ë°˜ë§ë¡œ,',
        'ë”°ëœ»í•˜ê³  ì¹œê·¼í•˜ê²Œ ì„¤ëª…í•´ì£¼ì„¸ìš”.',
        '',
        'ê²°ê³¼ëŠ” ë°˜ë“œì‹œ ì•„ë˜ í˜•ì‹ìœ¼ë¡œë§Œ ì¶œë ¥í•˜ì„¸ìš”:',
        '',
        '[ê½ƒë‹¤ë°œ ì„¤ëª…]',
        '(2~3ë¬¸ì¥, ë°˜ë§, ê°ì„±ì ìœ¼ë¡œ)',
        '',
        '[ëŒ€í‘œê½ƒ Â· ì»¨ì…‰ Â· ì´ìœ ]',
        'ëŒ€í‘œê½ƒ:',
        'ì»¨ì…‰:',
        'ì´ìœ : (1ë¬¸ì¥, ë°˜ë§)',
        '',
        '[ë©˜íŠ¸ 5ê°œ]',
        '1. "..."',
        '2. "..."',
        '3. "..."',
        '4. "..."',
        '5. "..."',
        '',
        '[ì œì‘ ê°€ì´ë“œ]',
        'í†¤:',
        'í¬ì¥:',
        'ì¡°í•©:',
        'ëŒ€ì²´ ê·œì¹™:',
        '',
        '[ê½ƒì§‘ ì „ë‹¬ ë¬¸ì¥]',
        '"..." (ë³µë¶™ìš© í•œ ë¬¸ë‹¨)',
        '',
        '[ì£¼ì˜ì‚¬í•­]',
        'Â· ...',
        'Â· ...',
        'Â· ...',
        '',
        'ë§íˆ¬ ì˜ˆì‹œ ë¹„êµ',
        'í˜„ì¬ê°œì„ "ì‚¬ë‘ê³¼ ì• ì •ì„ ìƒì§•í•˜ë©° ì í•©í•©ë‹ˆë‹¤""ì‚¬ë‘í•œë‹¤ëŠ” ë§ ëŒ€ì‹  ì´ ê½ƒìœ¼ë¡œ ì „ë‹¬í•´ë´""ìµœì í™”ëœ ì¡°í•©ì…ë‹ˆë‹¤""ì´ ì¡°í•©ì´ë©´ ì§„ì§œ ì‹¤íŒ¨ ì—†ì–´""í”¼í•´ì•¼ í•©ë‹ˆë‹¤""ì´ê±´ ì¢€ í”¼í•´ì¤˜, ë¶€ë‹´ìŠ¤ëŸ¬ì›Œ ë³´ì—¬"',
        '',
        `ë¬´ë£Œ ì„¤ë¬¸ ê²°ê³¼: ${JSON.stringify(payload)}`,
        '',
        'ì ˆëŒ€ ì¡´ëŒ“ë§ ì“°ì§€ ë§ê³ ,',
        '"-ì…ë‹ˆë‹¤", "-í•©ë‹ˆë‹¤" ì“°ì§€ ë§ˆì„¸ìš”.'
      ].join('\n');
    }

    function escapeHtml(value){
      return String(value || '')
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }

    function getPaletteMeta(paletteKey){
      const map = {
        white_green: {
          label: 'í™”ì´íŠ¸Â·ê·¸ë¦°',
          colors: ['#F8F7F2', '#D9D9D6', '#C9D4C5']
        },
        pink_peach: {
          label: 'í•‘í¬Â·í”¼ì¹˜',
          colors: ['#F7CAC9', '#F7B39B', '#F3E0BE']
        },
        lilac: {
          label: 'ì—°ë³´ë¼Â·ë¼ì¼ë½',
          colors: ['#E6D9F2', '#C7B6E6', '#9B84C9']
        },
        red_wine: {
          label: 'ë ˆë“œÂ·ë²„ê±´ë””',
          colors: ['#C94C5B', '#8B1E3F', '#F3D5DB']
        },
        yellow_orange: {
          label: 'ì˜ë¡œÂ·ì˜¤ë Œì§€',
          colors: ['#FFD23F', '#FF8C42', '#FFE9CC']
        }
      };
      return map[paletteKey] || null;
    }

    function paletteChipHtml(state){
      const meta = getPaletteMeta(state && state.palette);
      if (!meta) return '';
      const dots = meta.colors
        .map((hex) => `<div class="palette-dot" style="background:${escapeHtml(hex)};"></div>`)
        .join('');
      return [
        '<div class="result-palette">',
        '<div class="result-palette-title">ë¬´ë£Œê²°ê³¼ ì»¬ëŸ¬ì¹©</div>',
        `<div class="palette-row">${dots}</div>`,
        `<div class="result-palette-label">${escapeHtml(meta.label)}</div>`,
        '</div>'
      ].join('');
    }

    function formatPaidText(text, state){
      const base = escapeHtml(text || '').replace(/\r\n/g, '\n');
      const withSections = base.replace(/^\[(.+?)\]$/gm, '<strong class="result-section">[$1]</strong>');
      const paletteHtml = paletteChipHtml(state);
      const withPalette = paletteHtml
        ? withSections.replace('<strong class="result-section">[ì œì‘ ê°€ì´ë“œ]</strong>', `${paletteHtml}<strong class="result-section">[ì œì‘ ê°€ì´ë“œ]</strong>`)
        : withSections;
      return withPalette.replace(/\n/g, '<br/>');
    }

    async function runPaidGuide(){
      const btn = document.getElementById('btnRunPaid');
      const card = document.getElementById('paidResultCard');
      const body = document.getElementById('paidResultBody');
      const status = document.getElementById('paidResultStatus');
      const imageEl = document.getElementById('paidResultImage');
      if (!btn || !card || !body || !status || !imageEl) return;

      const state = getStateFromQuery();
      const prompt = buildPromptFromState(state);

      btn.disabled = true;
      btn.style.opacity = '0.7';
      card.classList.add('show');
      status.textContent = 'ìƒì„± ì¤‘';
      body.className = 'result-body loading';
      body.textContent = 'ëˆ„ë‚˜ê°€ ìœ ë£Œ ì¶”ì²œì„ ì •ë¦¬í•˜ê³  ìˆì–´...';
      imageEl.classList.remove('show');
      imageEl.removeAttribute('src');
      card.scrollIntoView({ behavior: 'smooth', block: 'start' });

      try {
        const res = await fetch('/api/pro', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ prompt })
        });
        if (!res.ok) throw new Error(`status_${res.status}`);

        const data = await res.json();
        const text = (data && data.text) ? data.text.trim() : '';
        if (!text) throw new Error('empty_text');
        const imageUrl = (data && data.image_url) ? String(data.image_url).trim() : '';

        status.textContent = 'ì™„ë£Œ';
        body.className = 'result-body';
        body.innerHTML = formatPaidText(text, state);
        if (imageUrl) {
          imageEl.src = imageUrl;
          imageEl.classList.add('show');
        }
      } catch (e) {
        status.textContent = 'ì‹¤íŒ¨';
        body.className = 'result-body error';
        body.textContent = 'ê²°ê³¼ ìƒì„±ì— ì‹¤íŒ¨í–ˆì–´. ì ì‹œ í›„ ë‹¤ì‹œ ëˆŒëŸ¬ì¤˜.';
        imageEl.classList.remove('show');
        imageEl.removeAttribute('src');
      } finally {
        btn.disabled = false;
        btn.style.opacity = '1';
      }
    }

    document.getElementById('btnRunPaid')?.addEventListener('click', runPaidGuide);
  </script>
</body>
</html>
